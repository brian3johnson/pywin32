
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Windows NT Security – Impersonation &#8212; pywin32 305 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Samples" href="samples/index.html" />
    <link rel="prev" title="Recursive directory deletes and special files" href="file_recursive.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="windows-nt-security-impersonation">
<h1>Windows NT Security – Impersonation<a class="headerlink" href="#windows-nt-security-impersonation" title="Permalink to this heading">¶</a></h1>
<div class="admonition-existing-document admonition">
<p class="admonition-title">Existing document</p>
<p><code class="file docutils literal notranslate"><span class="pre">\win32\help\security.d</span></code></p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#example" id="id1">Example</a></p></li>
</ul>
</nav>
<p>Python’s win32 access to help to simplify providing privileged access.</p>
<p>There may be times when you want to give specific access to someone with NT. One mechanism to do this is with the win32 calls: LogonUser and ImpersonateLoggedOnUser. LogonUser gives you a handel which ImpersonateLoggedOnUser can then use to “become” the user. To do this the thread calling, LogonUser, needs SE_TCB_NAME, SE_CHANGE_NOTIFY_NAME, and SE_ASSIGNPRIMARYTOKEN_NAME privileges. If you plan to do this with something like IIS and cgi, be careful, the anonymous account IIS uses is already impersonated from the system account. You will need to use the RevertToSelf, api call to first terminate the impersonation. And, the system account, a local account, ultimately limits you, regardless of who you log in as (COM/MTS can provide an alternative security solution).</p>
<section id="example">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Example</a><a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>The c++ api call for Logonasuser looks like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">BOOL</span><span class="w"> </span><span class="nf">LogonUser</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">LPTSTR</span><span class="w"> </span><span class="n">lpszUsername</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">LPTSTR</span><span class="w"> </span><span class="n">lpszDomain</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">LPTSTR</span><span class="w"> </span><span class="n">lpszPassword</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwLogonType</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwLogonProvider</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">PHANDLE</span><span class="w"> </span><span class="n">phToken</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The python documentation says this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PyHANDLE</span> <span class="o">=</span> <span class="n">LogonUser</span><span class="p">(</span> <span class="n">userName</span><span class="p">,</span> <span class="n">domain</span> <span class="p">,</span> <span class="n">password</span> <span class="p">,</span> <span class="n">logonType</span> <span class="p">,</span> <span class="n">logonProvider</span> <span class="p">)</span>
</pre></div>
</div>
<p>The api call is very similar in both cases except in python the handel is returned seperately to the caller. The interesting options in this case are logonType and logonProvider. To give values for these, you need to use the constants present in win32con (you can use the browser in pythonwin-&gt;tools to list the constants in win32con). Unless you have unusual server requirements, for logonType, win32con.LOGON32_LOGON_INTERACTIVE should be fine. With regards to logonProvider, generally use win32con.LOGON32_PROVIDER_DEFAULT - it’s for specifiying the type of logon NT 3.5, 4.0, win2000. Generally, default is fine.</p>
<p>ImpersonateLoggedOnUser is extremely simple and you’ll see it’s usage in the examples.</p>
<p>Now for some code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#A raw example looks like this:</span>
<span class="n">handel</span><span class="o">=</span><span class="n">win32security</span><span class="o">.</span><span class="n">LogonUser</span><span class="p">(</span><span class="s1">&#39;barney&#39;</span><span class="p">,</span><span class="s1">&#39;bedrock&#39;</span><span class="p">,</span><span class="s1">&#39;bambam&#39;</span>\
   <span class="p">,</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOGON32_LOGON_INTERACTIVE</span><span class="p">,</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOGON32_PROVIDER_DEFAULT</span><span class="p">)</span>
<span class="n">win32security</span><span class="o">.</span><span class="n">ImpersonateLoggedOnUser</span><span class="p">(</span><span class="n">handel</span><span class="p">)</span>

<span class="c1">#do stuff here</span>
<span class="nb">print</span> <span class="n">win32api</span><span class="o">.</span><span class="n">GetUserName</span><span class="p">()</span> <span class="c1">#show you&#39;re someone else</span>

<span class="n">win32security</span><span class="o">.</span><span class="n">RevertToSelf</span><span class="p">()</span> <span class="c1">#terminates impersonation</span>
<span class="n">handel</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="c1">#The impersonate code can be encapsulated in a class, which then makes it even more</span>
<span class="c1">#trivial to use</span>

<span class="kn">import</span> <span class="nn">win32security</span>
<span class="kn">import</span> <span class="nn">win32con</span>
<span class="kn">import</span> <span class="nn">win32api</span>

<span class="k">class</span> <span class="nc">Impersonate</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">login</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">=</span><span class="s1">&#39;bedrock&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="o">=</span><span class="n">login</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">=</span><span class="n">password</span>
   <span class="k">def</span> <span class="nf">logon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">handel</span><span class="o">=</span><span class="n">win32security</span><span class="o">.</span><span class="n">LogonUser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>\
      <span class="n">win32con</span><span class="o">.</span><span class="n">LOGON32_LOGON_INTERACTIVE</span><span class="p">,</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOGON32_PROVIDER_DEFAULT</span><span class="p">)</span>
      <span class="n">win32security</span><span class="o">.</span><span class="n">ImpersonateLoggedOnUser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handel</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">logoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">win32security</span><span class="o">.</span><span class="n">RevertToSelf</span><span class="p">()</span> <span class="c1">#terminates impersonation</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">handel</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> <span class="c1">#guarantees cleanup</span>


<span class="n">a</span><span class="o">=</span><span class="n">Impersonate</span><span class="p">(</span><span class="s1">&#39;barney&#39;</span><span class="p">,</span><span class="s1">&#39;bambam&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
   <span class="n">a</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span> <span class="c1">#become the user</span>
   <span class="c1">#do whatever here</span>
   <span class="nb">print</span> <span class="n">win32api</span><span class="o">.</span><span class="n">GetUserName</span><span class="p">()</span> <span class="c1">#show you&#39;re someone else</span>
   <span class="n">a</span><span class="o">.</span><span class="n">logoff</span><span class="p">()</span> <span class="c1">#return to normal</span>
<span class="k">except</span><span class="p">:</span>
   <span class="nb">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_type</span> <span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span>
</pre></div>
</div>
<p>Have a great time with programming with python!</p>
<p>John Nielsen   <a class="reference external" href="mailto:nielsenjf&#37;&#52;&#48;my-deja&#46;com">nielsenjf<span>&#64;</span>my-deja<span>&#46;</span>com</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pywin32</a></h1>



<p class="blurb">Python for Windows Extensions</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=mhammond&repo=pywin32&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Win32 Extensions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="process_info.html">Getting process info</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_directories.html">Extending Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="win32net.html">win32net</a></li>
<li class="toctree-l2"><a class="reference internal" href="event.html">Windows NT Eventlog</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_threading.html">Eventlog &amp; Threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="file.html">File Locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_recursive.html">Directory Deleting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Windows NT Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="samples/index.html">Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="apidoc/index.html">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../com/index.html">PythonCOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adodbapi/index.html">ADO DB-API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isapi/index.html">ISAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pythonwin/index.html"> Pythonwin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWIG/index.html">SWIG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Mark Hammond.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/win32/security.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>