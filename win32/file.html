
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Windows NT Files - Locking &#8212; pywin32 305 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Recursive directory deletes and special files" href="file_recursive.html" />
    <link rel="prev" title="Windows NT Eventlog and Threading" href="event_threading.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="windows-nt-files-locking">
<h1>Windows NT Files - Locking<a class="headerlink" href="#windows-nt-files-locking" title="Permalink to this heading">¶</a></h1>
<div class="admonition-existing-document admonition">
<p class="admonition-title">Existing document</p>
<p><code class="file docutils literal notranslate"><span class="pre">\win32\help\file.d</span></code> Part 1</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#example" id="id1">Example</a></p></li>
</ul>
</nav>
<p>Python’s win32 access for file locking - flock style</p>
<p>The need for file locking tends arise every so often. Some people may be used to flock style locking, which has 4 basic cases: shared, exclusive, blocking, and non-blocking. Shared locking is typically used when multiple people want to read a file. Exclusive is for writing. Blocking means that the process will wait until it is able to lock the file. Non-blocking will return immediately and tell you the lock failed. In win32 the standard CreateFile api gives you the ability to do exclusive or shared locking. However, what it does not give you is the ability to switch between blocking/non-blocking (it fails immediately - does not block). To do that, you need to use LockfileEx – which can even lock a specific part of a file.</p>
<p>The basic procedure for doing this is to first call Createfile to give you a filehandle. Then call LockfileEx with the filehandle. Do whatever to the file. Call UnlockfileEx. Then close the filehandle. (Some of you may want to close the filehandle to kill the locks, it doesn’t work that way with win32, at least according to the msdn).</p>
<p>Below is a class called Flock, which gives you exclusive/shared locking with non-blocking/blocking abilities. If you can think of any optimizations or changes, be sure to let me know.</p>
<p>CreateFile provides many options. It can be used for files,directories,mailslots,sockets, etc. In this case, we’re only interested in standard files.</p>
<p>The C++ call looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">HANDLE</span><span class="w"> </span><span class="nf">CreateFile</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">LPCTSTR</span><span class="w"> </span><span class="n">lpFileName</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwDesiredAccess</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwShareMode</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">LPSECURITY_ATTRIBUTES</span><span class="w"> </span><span class="n">lpSecurityAttributes</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwCreationDisposition</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwFlagsAndAttributes</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hTemplateFile</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The python call is virtually the same with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PyHANDLE</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span>
   <span class="n">fileName</span><span class="p">,</span>
   <span class="n">desiredAccess</span><span class="p">,</span>
   <span class="n">shareMode</span><span class="p">,</span>
   <span class="n">attributes</span><span class="p">,</span>
   <span class="n">creationDisposition</span><span class="p">,</span>
   <span class="n">flagsAndAttributes</span><span class="p">,</span>
   <span class="n">hTemplateFile</span>
   <span class="p">)</span>
</pre></div>
</div>
<p>The module win32con in python is invaluable for setting most of these attributes. Besides win32con, you need win32security to create a security attribute.</p>
<section id="example">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Example</a><a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>Here is a basic example of the raw program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">win32file</span>
<span class="kn">import</span> <span class="nn">win32con</span>
<span class="kn">import</span> <span class="nn">win32security</span>
<span class="kn">import</span> <span class="nn">win32api</span>
<span class="kn">import</span> <span class="nn">pywintypes</span>

<span class="n">highbits</span><span class="o">=</span><span class="mh">0xffff0000</span> <span class="c1">#high-order 32 bits of byte range to lock</span>
<span class="n">file</span><span class="o">=</span><span class="s2">&quot;c:</span><span class="se">\\</span><span class="s2">wilma.txt&quot;</span>
<span class="n">secur_att</span> <span class="o">=</span> <span class="n">win32security</span><span class="o">.</span><span class="n">SECURITY_ATTRIBUTES</span><span class="p">()</span>
<span class="n">secur_att</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>

<span class="n">hfile</span><span class="o">=</span><span class="n">win32file</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">(</span> <span class="n">file</span><span class="p">,</span>\
                           <span class="n">win32con</span><span class="o">.</span><span class="n">GENERIC_READ</span><span class="o">|</span><span class="n">win32con</span><span class="o">.</span><span class="n">GENERIC_WRITE</span><span class="p">,</span>\
                           <span class="n">win32con</span><span class="o">.</span><span class="n">FILE_SHARE_READ</span><span class="o">|</span><span class="n">win32con</span><span class="o">.</span><span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>\
                           <span class="n">secur_att</span><span class="p">,</span>\  <span class="c1">#default</span>
                           <span class="n">win32con</span><span class="o">.</span><span class="n">OPEN_ALWAYS</span><span class="p">,</span>\
                           <span class="n">win32con</span><span class="o">.</span><span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>

<span class="n">ov</span><span class="o">=</span><span class="n">pywintypes</span><span class="o">.</span><span class="n">OVERLAPPED</span><span class="p">()</span> <span class="c1">#used to indicate starting region to lock</span>
<span class="n">win32file</span><span class="o">.</span><span class="n">LockFileEx</span><span class="p">(</span><span class="n">hfile</span><span class="p">,</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOCKFILE_EXCLUSIVE_LOCK</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">highbits</span><span class="p">,</span><span class="n">ov</span><span class="p">)</span>
<span class="n">win32api</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="c1">#do something here</span>
<span class="n">win32file</span><span class="o">.</span><span class="n">UnlockFileEx</span><span class="p">(</span><span class="n">hfile</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">highbits</span><span class="p">,</span><span class="n">ov</span><span class="p">)</span>
<span class="n">hfile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
</pre></div>
</div>
<p>Below, I have fleshed it out with a more useable Flock class. The code below works like this: You create an instance of the class, providing a filename. It will create/access the file in a default way and provide an hfile filehandle. If you don’t want the default(shared/blocking), you can then specify in a dictionary what type of locking you want. Call the lock method on the file. Do whatever you want with the hfile filehandle, then call the unlock method which will remove the locks and close the filehandle.</p>
<p>Looking at the code below, for desiredAccess and shareMode, I have both read and write on for most flexibility. The OPEN_ALWAYS means that it will either use the current file or create a new one if none is to be found. I use default security for the security attributes option. The lock method basically determines what lock flags should be used, depending on the type of locking you want and then calls LockFileEx. An interesting option to LockFileEx is self.highbits. You can use that to specify portions of a file to lock instead of the entire thing. When you’re done with whatever you need to do, using the hfile, filehandle, if necessary, then call the unlock method, to remove the lock and close the filehandle.</p>
<p>Now for some code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Flock</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">=</span><span class="n">file</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LOCK_EX&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;LOCK_NB&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
      <span class="n">secur_att</span> <span class="o">=</span> <span class="n">win32security</span><span class="o">.</span><span class="n">SECURITY_ATTRIBUTES</span><span class="p">()</span>
      <span class="n">secur_att</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">highbits</span><span class="o">=</span><span class="mh">0xffff0000</span> <span class="c1">#high-order 32 bits of byte range to lock</span>
      <span class="c1">#make a handel with read/write and open or create if doesn&#39;t exist</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hfile</span><span class="o">=</span><span class="n">win32file</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>\
               <span class="n">win32con</span><span class="o">.</span><span class="n">GENERIC_READ</span><span class="o">|</span><span class="n">win32con</span><span class="o">.</span><span class="n">GENERIC_WRITE</span><span class="p">,</span>\
               <span class="n">win32con</span><span class="o">.</span><span class="n">FILE_SHARE_READ</span><span class="o">|</span><span class="n">win32con</span><span class="o">.</span><span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>\
               <span class="n">secur_att</span><span class="p">,</span>\
               <span class="n">win32con</span><span class="o">.</span><span class="n">OPEN_ALWAYS</span><span class="p">,</span>\
               <span class="n">win32con</span><span class="o">.</span><span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="s1">&#39;LOCK_EX&#39;</span><span class="p">]:</span>  <span class="c1">#exclusive locking</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="s1">&#39;LOCK_NB&#39;</span><span class="p">]:</span> <span class="c1">#don&#39;t wait, non-blocking</span>
            <span class="n">lock_flags</span><span class="o">=</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOCKFILE_EXCLUSIVE_LOCK</span><span class="o">|</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOCKFILE_FAIL_IMMEDIATELY</span>
         <span class="k">else</span><span class="p">:</span> <span class="c1">#wait for lock to free</span>
            <span class="n">lock_flags</span><span class="o">=</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOCKFILE_EXCLUSIVE_LOCK</span>
      <span class="k">else</span><span class="p">:</span> <span class="c1">#shared locking</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="s1">&#39;LOCK_NB&#39;</span><span class="p">]:</span> <span class="c1">#don&#39;t wait, non-blocking</span>
            <span class="n">lock_flags</span><span class="o">=</span><span class="n">win32con</span><span class="o">.</span><span class="n">LOCKFILE_FAIL_IMMEDIATELY</span>
         <span class="k">else</span><span class="p">:</span><span class="c1">#shared lock wait for lock to free</span>
            <span class="n">lock_flags</span><span class="o">=</span><span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ov</span><span class="o">=</span><span class="n">pywintypes</span><span class="o">.</span><span class="n">OVERLAPPED</span><span class="p">()</span> <span class="c1">#used to indicate starting region to lock</span>
      <span class="n">win32file</span><span class="o">.</span><span class="n">LockFileEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hfile</span><span class="p">,</span><span class="n">lock_flags</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">highbits</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ov</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">win32file</span><span class="o">.</span><span class="n">UnlockFileEx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hfile</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">highbits</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ov</span><span class="p">)</span> <span class="c1">#remove locks</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">hfile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="n">l</span><span class="o">=</span><span class="n">Flock</span><span class="p">(</span><span class="s2">&quot;c:</span><span class="se">\\</span><span class="s2">a3.txt&quot;</span><span class="p">)</span>
<span class="n">l</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="s1">&#39;LOCK_EX&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
<span class="n">l</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="s1">&#39;LOCK_NB&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

<span class="nb">print</span> <span class="s1">&#39;calling lock&#39;</span>
<span class="n">l</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
<span class="nb">print</span> <span class="s1">&#39;now locked &#39;</span>

<span class="n">win32api</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">l</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
<span class="nb">print</span> <span class="s1">&#39;now unlocked&#39;</span>
</pre></div>
</div>
<p>Have a great time with programming with python!</p>
<p>John Nielsen   <a class="reference external" href="mailto:nielsenjf&#37;&#52;&#48;my-deja&#46;com">nielsenjf<span>&#64;</span>my-deja<span>&#46;</span>com</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pywin32</a></h1>



<p class="blurb">Python for Windows Extensions</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=mhammond&repo=pywin32&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Win32 Extensions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="process_info.html">Getting process info</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_directories.html">Extending Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="win32net.html">win32net</a></li>
<li class="toctree-l2"><a class="reference internal" href="event.html">Windows NT Eventlog</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_threading.html">Eventlog &amp; Threading</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">File Locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_recursive.html">Directory Deleting</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Windows NT Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="samples/index.html">Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="apidoc/index.html">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../com/index.html">PythonCOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adodbapi/index.html">ADO DB-API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isapi/index.html">ISAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pythonwin/index.html"> Pythonwin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWIG/index.html">SWIG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Mark Hammond.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/win32/file.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>